<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenChess Home</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <div class="container">
        <h2>OpenChess Home</h2>
        <div class="status" id="status">Loading status...</div>

        <!-- WiFi Settings Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('wifi')">
                <span class="section-icon" id="wifi-icon">▶</span>
                <h3>WiFi Settings</h3>
            </div>
            <div class="section-content" id="wifi-content">
                <form id="wifiForm">
                    <div class="form-group">
                        <label for="ssid">WiFi SSID:</label>
                        <input type="text" name="ssid" id="ssid" value="" placeholder="Enter Your WiFi SSID">
                    </div>
                    <div class="form-group">
                        <label for="password">WiFi Password:</label>
                        <input type="text" name="password" id="password" value=""
                            placeholder="Enter Your WiFi Password">
                    </div>
                    <input type="submit" style="background-color: #4CAF50;" value="Connect to WiFi">
                </form>
            </div>
        </div>

        <!-- Lichess Settings Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('lichess')">
                <span class="section-icon" id="lichess-icon">▶</span>
                <h3>Lichess Settings</h3>
            </div>
            <div class="section-content" id="lichess-content">
                <p class="section-description">
                    Play Lichess games on your physical board.
                    <a href="https://lichess.org/account/oauth/token" target="_blank" style="color: #ec8703;">
                        Get your API token here
                    </a>
                </p>
                <div class="lichess-status" id="lichess-status">
                    <span id="lichess-token-status">No token configured</span>
                </div>
                <form id="lichessForm">
                    <div class="form-group">
                        <label for="lichessToken">API Token:</label>
                        <input type="password" name="lichessToken" id="lichessToken" value=""
                            placeholder="lip_xxxxxxxxxxxxx">
                    </div>
                    <input type="submit" style="background-color: #9c59b6;" value="Save Lichess Token">
                </form>
            </div>
        </div>

        <!-- Board Settings Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('board')">
                <span class="section-icon" id="board-icon">▶</span>
                <h3>Board Settings</h3>
            </div>
            <div class="section-content" id="board-content">
                <p class="section-description">
                    Adjust the LED brightness and dark square dimming for your chess board.
                </p>
                <form id="boardSettingsForm">
                    <div class="form-group">
                        <label for="brightness">LED Brightness: <span id="brightness-value">255</span></label>
                        <input type="range" id="brightness" name="brightness" min="10" max="255" value="255"
                            class="slider-input">
                    </div>
                    <div class="form-group">
                        <label for="dimMultiplier">Dark Square Dimming: <span id="dim-value">70</span>%</label>
                        <input type="range" id="dimMultiplier" name="dimMultiplier" min="20" max="100" value="70"
                            class="slider-input">
                    </div>
                    <input type="submit" style="background-color: #4CAF50;" value="Save LED Settings">
                </form>
                <div class="calibration-section">
                    <p class="section-description" style="margin-top: 15px; margin-bottom: 10px;">
                        Run board calibration to map LEDs and sensors to the correct squares.
                    </p>
                    <button type="button" id="calibrateBtn" class="button" style="background-color: #f44336;">
                        Start Board Calibration
                    </button>
                </div>
            </div>
        </div>

        <!-- OTA Update Section -->
        <div class="settings-section">
            <div class="section-header" onclick="toggleSection('ota')">
                <span class="section-icon" id="ota-icon">▶</span>
                <h3>OTA Update</h3>
            </div>
            <div class="section-content" id="ota-content">
                <p class="section-description">
                    Drop or select <code>firmware.bin</code> and <code>littlefs.bin</code> to update over-the-air.
                </p>
                <div class="form-group">
                    <div class="dropzone" id="dropzone">
                        <input type="file" id="otaFiles" accept=".bin" multiple style="display: none;">
                        <span class="dropzone-icon">&#128194;</span>
                        <span class="dropzone-text" id="dropzone-text">Click or drag .bin files here</span>
                        <div id="ota-file-list" class="ota-file-list"></div>
                        <div id="ota-progress-container" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="ota-progress-fill"></div>
                                <span class="ota-progress-text" id="ota-progress-text">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" id="otaBtn" class="button" style="background-color: #4CAF50;">
                    Update
                </button>
                <div id="ota-status-text" class="ota-status" style="display: none;"></div>
            </div>
        </div>

        <a href="./game.html" class="button">GameMode Selection</a>
        <a href="./board.html" class="button">View Board</a>
    </div>
    <script>
        // Section toggle state
        const sectionStates = {
            wifi: false,
            lichess: false,
            board: false,
            ota: false
        };

        function toggleSection(name) {
            sectionStates[name] = !sectionStates[name];
            const content = document.getElementById(name + '-content');
            const icon = document.getElementById(name + '-icon');

            if (sectionStates[name]) {
                content.classList.add('expanded');
                icon.textContent = '▼';
            } else {
                content.classList.remove('expanded');
                icon.textContent = '▶';
            }
        }

        function updateWiFiInfo(retries = 0, maxRetries = 20) {
            fetch('/wifi')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('ssid').value = data.ssid;
                    document.getElementById('password').value = data.password;
                    const isConnected = (data.connected || '').toString() === 'true';
                    const statusText = `SSID: ${data.ap_ssid} (${data.ap_ip})` + (isConnected ? ` | SSID: ${data.ssid} (${data.local_ip})` : ``);
                    document.getElementById('status').textContent = statusText;
                })
                .catch(() => {
                    if (retries < maxRetries) {
                        const delayMs = Math.min(500 + (retries * 300), 5000);
                        setTimeout(() => updateWiFiInfo(retries + 1, maxRetries), delayMs);
                    } else {
                        alert('Error fetching WiFi information. Please try again later.');
                    }
                });
        }

        function updateLichessInfo() {
            fetch('/lichess')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('lichess-token-status');
                    if (data.hasToken) {
                        statusEl.textContent = 'Token configured: ' + data.maskedToken;
                        statusEl.style.color = '#4CAF50';
                    } else {
                        statusEl.textContent = 'No token configured';
                        statusEl.style.color = '#f44336';
                    }
                })
                .catch(() => {
                    document.getElementById('lichess-token-status').textContent = 'Error loading status';
                });
        }

        // Fetch info on page load
        updateWiFiInfo();
        updateLichessInfo();
        updateBoardSettings();

        // Board settings functions
        function updateBoardSettings() {
            fetch('/board-settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('brightness').value = data.brightness;
                    document.getElementById('brightness-value').textContent = data.brightness;
                    document.getElementById('dimMultiplier').value = data.dimMultiplier;
                    document.getElementById('dim-value').textContent = data.dimMultiplier;
                })
                .catch(() => {
                    console.log('Error loading board settings');
                });
        }

        // Update slider value displays in real-time
        document.getElementById('brightness').addEventListener('input', function () {
            document.getElementById('brightness-value').textContent = this.value;
        });

        document.getElementById('dimMultiplier').addEventListener('input', function () {
            document.getElementById('dim-value').textContent = this.value;
        });

        // Handle board settings form submission
        document.getElementById('boardSettingsForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const brightness = document.getElementById('brightness').value;
            const dimMultiplier = document.getElementById('dimMultiplier').value;

            const formData = new URLSearchParams();
            formData.append('brightness', brightness);
            formData.append('dimMultiplier', dimMultiplier);

            fetch('/board-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        alert('LED settings saved successfully!');
                    } else {
                        alert('Failed to save settings. Please try again.');
                    }
                })
                .catch(() => {
                    alert('Error saving settings. Please try again.');
                });
        });

        // Handle calibration button
        document.getElementById('calibrateBtn').addEventListener('click', function () {
            if (confirm('This will clear the current board calibration. The board will need to be calibrated on the next reboot. Continue?')) {
                fetch('/board-calibrate', {
                    method: 'POST'
                })
                    .then(response => response.text())
                    .then(data => {
                        alert(data);
                    })
                    .catch(() => {
                        alert('Error starting calibration. Please try again.');
                    });
            }
        });

        // Handle WiFi form submission
        document.getElementById('wifiForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;

            document.getElementById('status').textContent = 'Connecting...';

            const formData = new URLSearchParams();
            formData.append('ssid', ssid);
            formData.append('password', password);

            fetch('/wifi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
                .then(response => response.text())
                .then(data => {
                    if (data === 'OK')
                        setTimeout(() => updateWiFiInfo(0, 20), 1000);
                    else
                        alert('Bad credentials or already connected to this WiFi.');

                })
                .catch(() => {
                    document.getElementById('status').textContent = 'Connecting... (retrying)';
                    setTimeout(() => updateWiFiInfo(0, 20), 1000);
                });
        });

        // OTA Update
        var ota = {
            dropzone: document.getElementById('dropzone'),
            input: document.getElementById('otaFiles'),
            fileList: document.getElementById('ota-file-list'),
            text: document.getElementById('dropzone-text'),
            progress: document.getElementById('ota-progress-container'),
            fill: document.getElementById('ota-progress-fill'),
            pct: document.getElementById('ota-progress-text'),
            status: document.getElementById('ota-status-text'),
            btn: document.getElementById('otaBtn')
        };
        var otaFiles = [];

        function otaSetState(state, msg) {
            var busy = state !== 'idle';
            ota.progress.style.display = state === 'uploading' ? 'block' : 'none';
            ota.dropzone.classList.toggle('disabled', busy);
            ota.btn.disabled = busy;
            ota.btn.textContent = { idle: 'Upload', uploading: 'Uploading...', rebooting: 'Rebooting...' }[state];
            if (msg) {
                ota.status.textContent = msg;
                ota.status.style.display = 'block';
                ota.status.style.color = '#f44336';
            } else {
                ota.status.style.display = 'none';
            }
        }

        function otaSetProgress(pct) {
            ota.fill.style.width = pct + '%';
            ota.pct.textContent = pct + '%';
        }

        function otaRenderFiles() {
            ota.fileList.innerHTML = '';
            ota.text.style.display = otaFiles.length ? 'none' : '';
            ota.dropzone.classList.toggle('has-file', otaFiles.length > 0);
            otaFiles.forEach(function (file, idx) {
                var row = document.createElement('div');
                row.className = 'ota-file-row';
                var name = document.createElement('span');
                name.className = 'ota-file-name';
                name.textContent = file.name;
                var remove = document.createElement('span');
                remove.className = 'ota-file-remove';
                remove.textContent = '\u2715';
                remove.onclick = function (e) {
                    e.stopPropagation();
                    otaFiles.splice(idx, 1);
                    otaRenderFiles();
                };
                row.appendChild(name);
                row.appendChild(remove);
                ota.fileList.appendChild(row);
            });
        }

        function otaAddFiles(newFiles) {
            for (var i = 0; i < newFiles.length; i++) {
                var f = newFiles[i];
                otaFiles = otaFiles.filter(function (e) { return e.name !== f.name; });
                otaFiles.push(f);
            }
            otaRenderFiles();
        }

        function otaPollReboot() {
            otaSetState('rebooting');
            var attempts = 0, offline = false;
            var poll = setInterval(function () {
                attempts++;
                fetch('/wifi', { signal: AbortSignal.timeout(3000) })
                    .then(function (r) {
                        if (r.ok && offline) {
                            clearInterval(poll);
                            setTimeout(function () { location.reload(); }, 500);
                        }
                    })
                    .catch(function () {
                        offline = true;
                        if (attempts >= 20) {
                            clearInterval(poll);
                            otaSetState('idle', 'Board did not come back online. Try refreshing manually.');
                        }
                    });
            }, 3000);
        }

        // Dropzone interactions
        ota.dropzone.addEventListener('click', function () { ota.input.click(); });
        ota.input.addEventListener('change', function () {
            if (ota.input.files.length) otaAddFiles(ota.input.files);
            ota.input.value = '';
        });
        ota.dropzone.addEventListener('dragover', function (e) { e.preventDefault(); ota.dropzone.classList.add('dragover'); });
        ota.dropzone.addEventListener('dragleave', function () { ota.dropzone.classList.remove('dragover'); });
        ota.dropzone.addEventListener('drop', function (e) {
            e.preventDefault();
            ota.dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length) otaAddFiles(e.dataTransfer.files);
        });

        // Upload
        ota.btn.addEventListener('click', function () {
            if (!otaFiles.length) return otaSetState('idle', 'Please select at least one .bin file');

            otaSetState('uploading');
            otaSetProgress(0);

            var formData = new FormData();
            otaFiles.forEach(function (f) { formData.append('ota', f, f.name); });

            var xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', function (e) {
                if (e.lengthComputable) {
                    otaSetProgress(Math.round((e.loaded / e.total) * 100));
                }
            });

            xhr.addEventListener('load', function () {
                if (xhr.status === 200) otaPollReboot();
                else otaSetState('idle', 'Update failed: ' + xhr.responseText);
            });

            xhr.addEventListener('error', function () {
                otaSetState('idle', 'Upload failed: connection error.');
            });

            xhr.open('POST', '/ota');
            xhr.send(formData);
        });

        // Handle Lichess form submission
        document.getElementById('lichessForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const token = document.getElementById('lichessToken').value;

            if (token.length < 10) {
                alert('Please enter a valid Lichess API token');
                return;
            }

            const formData = new URLSearchParams();
            formData.append('token', token);

            fetch('/lichess', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        alert('Lichess token saved successfully!');
                        document.getElementById('lichessToken').value = '';
                        updateLichessInfo();
                    } else {
                        alert('Failed to save token. Please try again.');
                    }
                })
                .catch(() => {
                    alert('Error saving token. Please try again.');
                });
        });
    </script>
</body>

</html>